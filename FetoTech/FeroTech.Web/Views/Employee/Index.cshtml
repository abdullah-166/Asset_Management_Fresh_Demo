@{
    ViewData["Title"] = "Employee Details";
}

<h2>Employee Details</h2>
<hr />

<div class="text-end mb-3">
    <a href="@Url.Action("Create", "Employee")" class="btn btn-success">+ Add Employee</a>
</div>

<link rel="stylesheet" href="https://cdn.datatables.net/2.3.4/css/dataTables.dataTables.min.css" />

<table id="employeeTable" class="display" style="width:100%">
    <thead>
        <tr>
            <th>Full Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Department</th>
            <th>Job Title</th>
            <th>Active</th>
            <th>Actions</th>
        </tr>
    </thead>
</table>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/2.3.4/js/dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function () {
            let table = new DataTable('#employeeTable', {
                ajax: {
                    url: '@Url.Action("GetAll", "Employee")',
                    dataSrc: ''
                },
                columns: [
                    { data: 'fullName' },
                    { data: 'email' },
                    { data: 'phone' },
                    { data: 'department' },
                    { data: 'jobTitle' },
                    {
                        data: 'isActive',
                        render: function (data) {
                            return data ? 'Yes' : 'No';
                        }
                    },
                    {
                        data: 'employeeId',
                        render: function (data, type, row) {
                            return `
                                <button class="btn btn-sm btn-primary edit-btn" data-id="${data}">Edit</button>
                                <button class="btn btn-sm btn-danger delete-btn" data-id="${data}">Delete</button>
                            `;
                        }
                    }
                ]
            });

            // -------- DELETE EMPLOYEE --------
            $('#employeeTable').on('click', '.delete-btn', function () {
                const id = $(this).data('id');

                Swal.fire({
                    title: 'Are you sure?',
                    text: "You want to delete this employee?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '@Url.Action("Delete", "Employee")',
                            type: 'POST',
                            data: { id: id },
                            success: function (response) {
                                if (response.success) {
                                    Swal.fire('Deleted!', response.message, 'success');
                                    table.ajax.reload();
                                } else {
                                    Swal.fire('Error!', response.message, 'error');
                                }
                            },
                            error: function () {
                                Swal.fire('Error!', 'Something went wrong.', 'error');
                            }
                        });
                    }
                });
            });

            // -------- EDIT EMPLOYEE --------
            $('#employeeTable').on('click', '.edit-btn', function () {
                const id = $(this).data('id');

                $.ajax({
                    url: '@Url.Action("GetById", "Employee")',
                    type: 'GET',
                    data: { id: id },
                    success: function (response) {
                        if (response.success) {
                            const emp = response.data;
                            Swal.fire({
                                title: 'Edit Employee',
                                html: `
                                    <input id="fullName" class="swal2-input" value="${emp.fullName}" placeholder="Full Name">
                                    <input id="email" class="swal2-input" value="${emp.email}" placeholder="Email">
                                    <input id="phone" class="swal2-input" value="${emp.phone}" placeholder="Phone">
                                    <input id="department" class="swal2-input" value="${emp.department}" placeholder="Department">
                                    <input id="jobTitle" class="swal2-input" value="${emp.jobTitle}" placeholder="Job Title">
                                    <label><input type="checkbox" id="isActive" ${emp.isActive ? 'checked' : ''}/> Active</label>
                                `,
                                showCancelButton: true,
                                confirmButtonText: 'Save'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    $.ajax({
                                        url: '@Url.Action("Edit", "Employee")',
                                        type: 'POST',
                                        data: {
                                            EmployeeId: emp.employeeId,
                                            FullName: $('#fullName').val(),
                                            Email: $('#email').val(),
                                            Phone: $('#phone').val(),
                                            Department: $('#department').val(),
                                            JobTitle: $('#jobTitle').val(),
                                            IsActive: $('#isActive').is(':checked')
                                        },
                                        success: function (res) {
                                            if (res.success) {
                                                Swal.fire('Updated!', res.message, 'success');
                                                table.ajax.reload();
                                            } else {
                                                Swal.fire('Error!', res.message, 'error');
                                            }
                                        },
                                        error: function () {
                                            Swal.fire('Error!', 'Something went wrong.', 'error');
                                        }
                                    });
                                }
                            });
                        } else {
                            Swal.fire('Error!', response.message, 'error');
                        }
                    }
                });
            });
        });
    </script>
}
